package vista;

import controlador.GestorTablero;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.HPos;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.MenuItem;
import javafx.scene.control.Button;
import javafx.scene.layout.GridPane;
import javafx.scene.shape.Circle;
import javafx.scene.text.Text;
import javafx.stage.Stage;
import modelo.Casilla;
import modelo.Evento;
import modelo.Jugador;

import java.util.List;
import java.util.Random;

public class pantallaJuegoController {

    // --- Menu Bar ---
    @FXML private MenuItem newGame;
    @FXML private MenuItem saveGame;
    @FXML private MenuItem loadGame;
    @FXML private MenuItem quitGame;

    // --- Tablero UI ---
    @FXML private GridPane tablero;
    @FXML private Circle P1;
    @FXML private Circle P2;
    @FXML private Circle P3;
    @FXML private Circle P4;

    // --- Centro de control de tiradas y eventos ---
    @FXML private Text dadoResultText;
    @FXML private Button dado;
    @FXML private Text rapido_t;
    @FXML private Text lento_t;
    @FXML private Text peces_t;
    @FXML private Text nieve_t;
    @FXML private Button rapido;
    @FXML private Button lento;
    @FXML private Button peces;
    @FXML private Button nieve;
    @FXML private Text eventos;

    // --- Lógica de juego ---
    private List<Jugador> jugadores;
    private Jugador jugadorActual;
    private int turnoActual = 0;
    private GestorTablero gestorTablero;
    private Random rnd = new Random();

    /** Inicialización mínima del controlador FXML */
    public void initialize() {
        gestorTablero = new GestorTablero();
        // Los jugadores se asignan después con setJugadores()
    }

    /** Recibe la lista de jugadores y prepara el primer turno */
    public void setJugadores(List<Jugador> jugadores) {
        this.jugadores = jugadores;
        this.turnoActual = 0;
        this.jugadorActual = jugadores.get(0);
        dibujarTablero();
        actualizarVista();
    }

    /** Dibuja las casillas en el GridPane */
    private void dibujarTablero() {
        tablero.getChildren().clear();
        int cols = 5; // 50 casillas => 10 filas de 5 columnas
        for (int i = 0; i < 50; i++) {
            int row = i / cols;
            int col = i % cols;
            Text txt = new Text(String.valueOf(i));
            GridPane.setHalignment(txt, HPos.CENTER);
            tablero.add(txt, col, row);
        }
    }

    /** Mueve la ficha de cada jugador según su posición */
    private void moverFicha(Circle ficha, int posicion) {
        int cols = 5;
        int row = posicion / cols;
        int col = posicion % cols;
        GridPane.setRowIndex(ficha, row);
        GridPane.setColumnIndex(ficha, col);
    }

    /** Actualiza todos los textos y posiciones en pantalla */
    private void actualizarVista() {
        rapido_t.setText("Dado rápido: " + jugadorActual.getInventario().getDados());
        lento_t .setText("Dado lento: "  + jugadorActual.getInventario().getDados());
        peces_t .setText("Peces: "        + jugadorActual.getInventario().getPeces());
        nieve_t .setText("Bolas de nieve: "+ jugadorActual.getInventario().getBolasNieve());

        rapido.setDisable(jugadorActual.getInventario().getDados() == 0);
        lento .setDisable(jugadorActual.getInventario().getDados() == 0);
        peces .setDisable(jugadorActual.getInventario().getPeces() == 0);
        nieve .setDisable(jugadorActual.getInventario().getBolasNieve() == 0);

        for (int i = 0; i < jugadores.size(); i++) {
            Circle ficha = switch (i) {
                case 0 -> P1;
                case 1 -> P2;
                case 2 -> P3;
                default -> P4;
            };
            moverFicha(ficha, jugadores.get(i).getPosicion());
        }
    }

    /** Procesa el movimiento según el tipo de casilla */
    private void procesarMovimiento(int pasos) {
        jugadorActual.mover(pasos);
        Casilla cas = gestorTablero.getTablero().getCasilla(jugadorActual.getPosicion());
        switch (cas.getTipo()) {
            case "OSO" -> {
                if (!jugadorActual.getInventario().usarPez()) {
                    jugadorActual.setPosicion(0);
                }
                eventos.setText("Ha caído en OSO");
            }
            case "AGUJERO" -> {
                int pos = jugadorActual.getPosicion();
                for (int i = pos - 1; i >= 0; i--) {
                    if (gestorTablero.getTablero().getCasilla(i).getTipo().equals("AGUJERO")) {
                        jugadorActual.setPosicion(i);
                        break;
                    }
                }
                eventos.setText("Ha caído en AGUJERO");
            }
            case "TRINEO" -> {
                int pos = jugadorActual.getPosicion();
                for (int i = pos + 1; i < gestorTablero.getTablero().getNumCasillas(); i++) {
                    if (gestorTablero.getTablero().getCasilla(i).getTipo().equals("TRINEO")) {
                        jugadorActual.setPosicion(i);
                        break;
                    }
                }
                eventos.setText("Ha usado TRINEO");
            }
            case "INTERROGANTE" -> {
                Evento.activarEvento(jugadorActual);
                eventos.setText("Evento aleatorio activado");
            }
            default -> eventos.setText("");
        }
        dadoResultText.setText("Ha salido: " + pasos);
    }

    /** Pasa el turno al siguiente jugador */
    private void siguienteTurno() {
        turnoActual = (turnoActual + 1) % jugadores.size();
        jugadorActual = jugadores.get(turnoActual);
        actualizarVista();
    }

    // --- Handlers del menú ---
    @FXML private void handleNewGame(ActionEvent e)  { /* lógica Nuevo Juego */ }
    @FXML private void handleSaveGame(ActionEvent e) { /* lógica Guardar */ }
    @FXML private void handleLoadGame(ActionEvent e) { /* lógica Cargar */ }
    @FXML private void handleQuitGame(ActionEvent e) { System.exit(0); }

    // --- Handlers de tiradas y acciones ---
    @FXML
    private void handleDado(ActionEvent e) {
        int tirada = rnd.nextInt(6) + 1;
        procesarMovimiento(tirada);
        siguienteTurno();
    }

    @FXML
    private void handleRapido(ActionEvent e) {
        if (jugadorActual.getInventario().usarDado()) {
            int tirada = 5 + rnd.nextInt(6);
            procesarMovimiento(tirada);
            siguienteTurno();
        }
    }

    @FXML
    private void handleLento(ActionEvent e) {
        if (jugadorActual.getInventario().usarDado()) {
            int tirada = 1 + rnd.nextInt(3);
            procesarMovimiento(tirada);
            siguienteTurno();
        }
    }

    @FXML
    private void handlePeces(ActionEvent e) {
        // Puedes usar esto para subornar al oso dentro de procesarMovimiento
    }

    @FXML
    private void handleNieve(ActionEvent e) {
        if (jugadorActual.getInventario().usarBola()) {
            int víctima = (turnoActual + 1) % jugadores.size();
            jugadores.get(víctima).mover(-1);
            siguienteTurno();
        }
    }
}
